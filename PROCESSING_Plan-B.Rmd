---
title: "TERN - morphology data for SLGA II - PLAN B"
output: html_document
author: "Lauren O'Brien"
date: `r Sys.Date()`
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Experiments with extracting and formatting soils morphology data in a form useful for TERN SLGA II modelling. Outputs will be published as a Web Feature Service. Potential for further development into a regular soils data service.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'hold', fig.height = 6,
                      fig.align = 'center', warning = FALSE, message = FALSE,
                      eval = FALSE)
```

```{r pkgs, results = 'hide'}
options(stringsAsFactors = FALSE, scipen = 999)
library(sf)            # vector data IO and processing
library(DBI)           # database interface
library(ROracle)       # Oracle database drivers
library(getPass)       # password management
library(units)         # for working with unit-attributed data
library(tidyverse)     # general data manipulation and display

Sys.setenv(
  'TNS_ADMIN'   = file.path('C:', 'Users', Sys.getenv('USERNAME'), 'Oracle'),
  'ORACLE_HOME' = 'C:/Program Files/Oracle Instant Client'
  )
SALI <- dbConnect(dbDriver('Oracle'),
                  username = 'obrienle',
                  password = getPass(),
                  dbname   = 'sispda',
                  host     = 'ex02client01',
                  port     = 1521)
```

Exploring an alternate option where the service structure follows the SALI SITE database structure more closely. Layer 1 will still have the calculated summaries seen in 'PROCESSING_Layer-1.Rmd', but some data like soil classification will be punted out to its own table.

Pros: Less wasted space in tables, easier to metadata and visualise, more efficient downloading
Cons: Some more complex queries might be forced client-side.  

## Structure

  * Layer 1 - Sites summary data (to observation level plus calculated values)
  * Layer 2 - Soil Classification (all data)
  * Layer 3 - Disturbance, Microrelief, Erosion and Surface Condition
  * Layer 4 - Surface Coarse Fragments and Rock Outcrop
  * Layer 5 - Horizon definitions (name, thickness, colour, texture etc plus some summaries tba)
  * Layer 6 - Horizon colours
  * Layer 7 - Horizon mottles 
  * Layer 8 - Horizon structures
  * Layer 9 - Horizon coarse fragments and segregations
  * Layer 10 - Horizon pans, cutans, fabrics
  * Layer 11 - Horizon cracks, macropores and roots
  * Layer 12 - Field tests
  * Layer 13 - Samples (maybe with cross link to soil chem API)
  * Layer 12 - Vegetation descriptions

Load data snapshot from 'DATA_sali-extract.Rmd'.

```{r getdat}
today <- '20191024' 
sit_datafile <- file.path(getwd(), 'SALI_DATA', 
                          paste0('SALI_SIT-data_', today, '.rds'))
sit_data <- readRDS(sit_datafile)
```

### Layer 1

```{r layer1}
sitobs_base <- 
    dbGetQuery(SALI, 
               "select project_code, site_id, obs_no,
                 obs_date, site_type, obs_type,
                 longitude, latitude, loc_accuracy, loc_meas_method,
                 runoff, permeability, drainage, lith_code, land_use_code,
                 slope_eval_method, slope_pct, slope_class, slope_morph_type, 
                 elem_inc_slope, elem_type_code,
                 modal_slope, relief_class, rel_mod_slope_class, patt_type_code
               from reg_projects
               join sit_sites using (project_code)
               join sit_observations using (project_code, site_id)
               join sit_locations using (project_code, site_id, obs_no)
               where avail_status = 'E'
               and site_qc_status = 'P'
               and datum = 3
               order by project_code, site_id, obs_no") %>% 
    dplyr::filter(LONGITUDE > 1) # >:-(

 # add in summary stuff from L1
```

### Layer 2 - Classifications

Ditching `TECH_REF_CODE` because the contents don't currently make any sense. ASC level data is also slightly stuffed atm. Renaming some of the ASC fields for greater consistency and easier querying.

```{r layer2}
loc <- sit_data[['LOC']] %>%  
  dplyr::select(PROJECT_CODE, SITE_ID, OBS_NO, LONGITUDE, LATITUDE)

layer_2 <- sit_data[['CLA']] %>% 
  rename(ASC_SORD = SUBORD_ASC_CODE,
         ASC_GGRP = GREAT_GROUP_ASC_CODE,
         ASC_SGRP = SUBGROUP_ASC_CODE,
         GSG_1    = EXHIBIT_GSG_CODE,
         GSG_2    = AFFINITY_GSG_CODE
         ) %>% 
  dplyr::select(PROJECT_CODE, SITE_ID, OBS_NO, SOIL_CLASS_NO, BURIED_FLAG,
                ASC_CONFIDENCE, ASC_ORD, ASC_SORD, ASC_GGRP, ASC_SGRP,
                ASC_FAM1, ASC_FAM2, ASC_FAM3, ASC_FAM4, ASC_FAM5, PPF,
                GSG_1, GSG_2) %>% 
  left_join(., loc,
            by = c('PROJECT_CODE', 'SITE_ID', 'OBS_NO')) %>%
  dplyr::arrange(PROJECT_CODE, SITE_ID, OBS_NO, SOIL_CLASS_NO) %>% 
  filter(!is.na(LONGITUDE)) %>% 
  st_as_sf(., coords = c('LONGITUDE', 'LATITUDE'), crs = 4283)
  
# e.g. 
plot(dplyr::filter(layer_2, PROJECT_CODE == 'BAB')['ASC_ORD'], pch = 20)

```

### Layer 3 - Disturbance, Microrelief, Erosion and Surface Condition

These are all soil surface parameters where multiple entries are possible.

Microrelief is massaged a bit here for clarity - the yellow book codes are poorly structured at V3

```{r layer3}

dis <- sit_data[['DIS']] %>% 
  mutate(PARAM = 'DISTURBANCE') %>% 
  rename(PARAM_NO = DISTURB_NO) %>% 
  dplyr::select(-matches('CREAT'), -matches('UPDAT'))

ero <- sit_data[['ERO']] %>% 
  mutate(PARAM = 'EROSION') %>% 
  rename(PARAM_NO        = ERO_NO,
         ERO_GULLY_DEPTH = GULLY_DEPTH) %>% 
  dplyr::select(-matches('CREAT'), -matches('UPDAT'))

mic <- sit_data[['MIC']] %>% 
  dplyr::select(-matches('CREAT'), -matches('UPDAT')) %>% 
  mutate(PARAM = 'MICRORELIEF',
         MICRO_GROUP = 
           case_when(MICRO_TYPE == 'Z'                 ~ 'Z', # None
                     MICRO_TYPE %in% 
                       c('C', 'N', 'L', 'A', 'M', 'G') ~ 'G', # Gilgai
                     MICRO_TYPE %in% c('D', 'W')       ~ 'H', # Hummocky
                     MICRO_TYPE %in% 
                       c('U', 'K', 'I', 'S', 'R', 'T',
                         'P', 'H', 'O')                ~ 'O', # Other,
                     MICRO_TYPE == 'B'                 ~ 'B', # Biotic
                     TRUE ~ NA_character_),
         # MICRO_TYPE usually '-' or 'Z' or 'O' which isn't useful
         # also a fair few mistakes like 'N' with 'O'
         MICRO_GROUP = ifelse(is.na(BIOTIC_AGENT), MICRO_GROUP, 'B')) %>%
  rename(PARAM_NO         = MICRO_NO, 
         MIC_PROP_GILGAI  = PROPORTION_GILGAI,
         MIC_VI           = VERTICAL_INTERVAL,
         MIC_HI           = HORIZ_INTERVAL) 

scn <- sit_data[['SCN']] %>% 
  mutate(PARAM = 'SURF_COND') %>% 
  rename(PARAM_NO = SURF_COND_NO, SURF_COND_STATUS = STATUS) %>% 
  dplyr::select(-matches('CREAT'), -matches('UPDAT'))

layer_3 <- reduce(list(loc, dis, scn, mic, ero),
                  function(x, y) {
                    full_join(x, y, by = intersect(names(x), names(y)))
                    }
                  ) %>% 
  dplyr::select(PROJECT_CODE, SITE_ID, OBS_NO, LONGITUDE, LATITUDE, 
                PARAM, PARAM_NO, everything()) %>% 
  filter(!is.na(LONGITUDE)) %>% 
  st_as_sf(., coords = c('LONGITUDE', 'LATITUDE'), crs = 4283)
                
# e.g.
plot(dplyr::filter(layer_3, PROJECT_CODE == 'BAB')['DISTURB_TYPE'], pch = 20)

```

### Layer 4 - Surface Coarse Fragments and Rock Outcrop

NB review abundance column as the decoes aren't quite the same...

```{r layer4}
scf <- sit_data[['SCF']] %>% 
  mutate(PARAM = 'SURF_FRAGS') %>% 
  rename(PARAM_NO = SURF_FRAG_NO,
         SURF_FRAG_SHAPE = SHAPE,
         SURF_FRAG_STRENGTH = STRENGTH) %>% 
  dplyr::select(-matches('CREAT'), -matches('UPDAT'))

otc <- sit_data[['OTC']] %>% 
  mutate(PARAM = 'OUTCROP') %>% 
  rename(PARAM_NO = OUTCROP_NO) %>% 
  dplyr::select(-matches('CREAT'), -matches('UPDAT'))

layer_4 <- reduce(list(loc, scf, otc),
                  function(x, y) {
                    full_join(x, y, by = intersect(names(x), names(y)))
                    }
                  ) %>% 
  dplyr::select(PROJECT_CODE, SITE_ID, OBS_NO, LONGITUDE, LATITUDE, 
                PARAM, PARAM_NO, everything()) %>% 
  filter(!is.na(LONGITUDE)) %>% 
  st_as_sf(., coords = c('LONGITUDE', 'LATITUDE'), crs = 4283) 

# e.g.
plot(dplyr::filter(layer_4, PROJECT_CODE == 'BAB')['LITH_CODE'], pch = 20)

```


